# roles/lxc-adguard/tasks/main.yml
---
# Install AdGuard Home on the container, utilizing bind mounts for persistence.

- name: Install dependencies (Unarchive/Networking)
  ansible.builtin.apt:
    name: [curl, tar, gzip]
    state: present
  tags: [adguard, packages]

- name: Create AdGuard group/user
  ansible.builtin.user:
    name: adguard
    shell: /usr/sbin/nologin
    system: yes
    create_home: no
  tags: [adguard, user]

- name: Download AdGuardHome archive
  ansible.builtin.get_url:
    url: "{{ adguard_download_url }}"
    dest: "/tmp/AdGuardHome.tar.gz"
  tags: [adguard, install]

- name: Extract AdGuardHome
  ansible.builtin.unarchive:
    src: "/tmp/AdGuardHome.tar.gz"
    dest: "/opt/"
    remote_src: true
    creates: "/opt/AdGuardHome/AdGuardHome"
  tags: [adguard, install]

- name: Deploy initial AdGuardHome configuration
  ansible.builtin.template:
    src: AdGuardHome.yml.j2
    dest: /var/lib/adguardhome/conf/AdGuardHome.yaml
    owner: root
    group: root
    mode: '0644'
    force: no # Ensures idempotence (doesn't overwrite if exists)
  notify: Restart AdGuard
  tags: [adguard, config]

- name: Install AdGuard Service
  ansible.builtin.command:
    # Point -c to the persistent config file
    cmd: "/opt/AdGuardHome/AdGuardHome -s install -c /var/lib/adguardhome/conf/AdGuardHome.yaml"
  # FIX: 'chdir' and 'creates' must be at the same level as 'cmd', NOT under 'args'
  args:
    chdir: /opt/AdGuardHome
    creates: /etc/systemd/system/AdGuardHome.service
  tags: [adguard, service]

- name: Ensure AdGuard Service is enabled and running
  ansible.builtin.systemd:
    name: AdGuardHome
    state: started
    enabled: true
  tags: [adguard, service]

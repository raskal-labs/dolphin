# roles/lxc-adguard/tasks/main.yml
---
# Install AdGuard Home on the container, utilizing bind mounts for persistence.

- name: Install dependencies (Unarchive/Networking)
  ansible.builtin.apt:
    name: [curl, tar, gzip]
    state: present
  tags: [adguard, packages]

- name: Create AdGuard group/user (Required by AdGuard installer)
  ansible.builtin.user:
    name: adguard
    shell: /usr/sbin/nologin
    system: yes
    create_home: no
  tags: [adguard, user]

- name: Download AdGuardHome archive
  ansible.builtin.get_url:
    url: "{{ adguard_download_url }}"
    dest: "/tmp/AdGuardHome.tar.gz"
  tags: [adguard, install]

- name: Extract AdGuardHome (only runs if binary does not exist)
  ansible.builtin.unarchive:
    src: "/tmp/AdGuardHome.tar.gz"
    dest: "/opt/"
    remote_src: true
    creates: "/opt/AdGuardHome/AdGuardHome"
  tags: [adguard, install]

# We rely on the persistent directories being mounted by pve-lxc
- name: Deploy initial AdGuardHome configuration (only if config file missing)
  ansible.builtin.template:
    src: AdGuardHome.yml.j2
    dest: /var/lib/adguardhome/AdGuardHome.yaml
    owner: root
    group: root
    mode: '0644'
    creates: /var/lib/adguardhome/AdGuardHome.yaml # CRITICAL: Idempotency, do not overwrite user changes
  notify: Restart AdGuard
  tags: [adguard, config]

- name: Install AdGuard Service (Systemd registration)
  ansible.builtin.command:
    cmd: "/opt/AdGuardHome/AdGuardHome -s install -c /var/lib/adguardhome/AdGuardHome.yaml"
    args:
      chdir: /opt/AdGuardHome
      creates: /etc/systemd/system/AdGuardHome.service
  tags: [adguard, service]

- name: Ensure AdGuard Service is enabled and running
  ansible.builtin.systemd:
    name: AdGuardHome
    state: started
    enabled: true
  tags: [adguard, service]

# roles/pve-vm/tasks/vm.yml

# 1. Check if VM exists
- name: Check if VM {{ pve_vm.vmid }} exists
  command: "qm status {{ pve_vm.vmid }}"
  register: vm_status
  ignore_errors: true

- name: Set exists flag
  set_fact:
    vm_exists: "{{ vm_status.rc == 0 }}"

# 2. Create VM shell
- name: Create VM {{ pve_vm.vmid }}
  command: >
    qm create {{ pve_vm.vmid }}
    --name {{ pve_vm.name }}
    --memory {{ pve_vm.memory }}
    --cores {{ pve_vm.cores }}
    --net0 virtio,bridge={{ pve_vm.net_bridge | default(pve_vm_defaults.net_bridge) }}
    --scsihw virtio-scsi-pci
    --serial0 socket
  when: not vm_exists

# 3. Import disk image into VM storage
- name: Import disk image into storage
  command: >
    qm importdisk {{ pve_vm.vmid }}
    {{ pve_vm_defaults.iso_path }}
    {{ pve_vm.storage | default(pve_vm_defaults.storage) }}
  when: not vm_exists

# 4. Attach imported disk as scsi0
- name: Attach disk to VM {{ pve_vm.vmid }}
  command: >
    qm set {{ pve_vm.vmid }}
    --scsi0 {{ pve_vm.storage }}:vm-{{ pve_vm.vmid }}-disk-0
  when: not vm_exists

# 5. Add Cloud-Init drive
- name: Add Cloud-Init drive
  command: >
    qm set {{ pve_vm.vmid }}
    --ide2 {{ pve_vm_defaults.cloudinit_storage }}:cloudinit
  when: not vm_exists

# 6. Network + SSH configuration (Cloud-Init)
- name: Configure Cloud-Init networking + root SSH
  command: >
    qm set {{ pve_vm.vmid }}
    --ipconfig0 ip={{ pve_vm.ip }},gw={{ pve_vm.gateway }}
    --sshkey /root/.ssh/id_ed25519_ansible.pub
    --ciuser root
  when: not vm_exists

# 7. Resize disk
- name: Resize disk if needed
  command: >
    qm resize {{ pve_vm.vmid }} scsi0 {{ pve_vm.disk }}
  when: not vm_exists

# 8. Regenerate cloud-init ISO
- name: Regenerate Cloud-Init configuration
  command: "qm cloudinit update {{ pve_vm.vmid }}"

# 9. Start VM
- name: Start VM {{ pve_vm.vmid }}
  command: "qm start {{ pve_vm.vmid }}"

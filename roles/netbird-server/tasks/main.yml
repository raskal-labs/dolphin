---
# roles/netbird-server/tasks/main.yml
#
# Deploy NetBird self-hosted stack (management, dashboard, signal, relay, coturn)
# inside this host (randnet) using Docker Compose and the official configure.sh flow.

- name: Ensure required packages are installed (Docker, Git, tooling)
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-compose
      - git
      - jq
      - curl
      - gettext-base
    state: present
    update_cache: true

- name: Ensure Docker service is enabled and running
  systemd:
    name: docker
    enabled: yes
    state: started

- name: Ensure netbird source directory exists
  ansible.builtin.file:
    path: /opt/netbird-src
    state: directory
    mode: "0755"

- name: Clone or update NetBird repository
  ansible.builtin.git:
    repo: "https://github.com/netbirdio/netbird.git"
    dest: /opt/netbird-src
    version: "main"
    depth: 1
    update: true

- name: Ensure infrastructure_files working dir exists
  ansible.builtin.file:
    path: /opt/netbird-src/infrastructure_files
    state: directory
    mode: "0755"

- name: Render setup.env from template
  ansible.builtin.template:
    src: setup.env.j2
    dest: /opt/netbird-src/infrastructure_files/setup.env
    mode: "0600"

- name: Run NetBird configure.sh to generate artifacts
  ansible.builtin.command:
    cmd: ./configure.sh
    chdir: /opt/netbird-src/infrastructure_files
  register: netbird_configure
  changed_when: "'artifacts/docker-compose.yml' in netbird_configure.stdout or 'Generating artifacts' in netbird_configure.stdout"
  environment:
    NETBIRD_DOMAIN: "{{ netbird_domain }}"

- name: Ensure NetBird runtime directory exists
  ansible.builtin.file:
    path: /opt/netbird
    state: directory
    mode: "0755"

- name: Copy generated docker-compose.yml
  ansible.builtin.copy:
    src: /opt/netbird-src/infrastructure_files/artifacts/docker-compose.yml
    dest: /opt/netbird/docker-compose.yml
    mode: "0644"
    remote_src: true

- name: Copy generated management.json
  ansible.builtin.copy:
    src: /opt/netbird-src/infrastructure_files/artifacts/management.json
    dest: /opt/netbird/management.json
    mode: "0644"
    remote_src: true

- name: Copy generated turnserver.conf
  ansible.builtin.copy:
    src: /opt/netbird-src/infrastructure_files/artifacts/turnserver.conf
    dest: /opt/netbird/turnserver.conf
    mode: "0644"
    remote_src: true

- name: Ensure NetBird data volume directory exists
  ansible.builtin.file:
    path: /opt/netbird/data
    state: directory
    mode: "0755"

- name: Bring up NetBird Docker stack
  ansible.builtin.command:
    cmd: docker-compose up -d
    chdir: /opt/netbird
  register: netbird_compose
  changed_when: >
    'Creating' in netbird_compose.stdout or
    'Recreating' in netbird_compose.stdout or
    'Starting' in netbird_compose.stdout

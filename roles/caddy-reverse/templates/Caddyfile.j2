# roles/caddy-reverse/templates/Caddyfile.j2

{
    email {{ caddy_email }}
}

# ---------------------------------------------------------
# Root Landing Page
# ---------------------------------------------------------
{{ caddy_root_domain }} {
    respond "warp-zone Caddy is alive" 200
}

# ---------------------------------------------------------
# NetBird (randnet) - THE FIX IS HERE
# ---------------------------------------------------------
{{ caddy_netbird_domain }} {
    # 1. Management API & Signal (GRPC/HTTP)
    # Forward paths starting with /api, /management, or /signal to the Management Service (Port 33073)
    @api {
        path /api*
        path /management*
        path /signal*
    }
    reverse_proxy @api {{ caddy_netbird_upstream }}:{{ caddy_netbird_api_port }} {
        header_up X-Forwarded-Proto {scheme}
    }

    # 2. NetBird Signal Service (Pure gRPC)
    # Matches gRPC content types for signaling (Port 33080/10000)
    @signal_grpc {
        header Content-Type application/grpc*
    }
    reverse_proxy @signal_grpc {{ caddy_netbird_upstream }}:{{ caddy_netbird_signal_grpc_port }} {
        flush_interval -1
    }

    # 3. Dashboard UI (Default)
    # Everything else goes to the Nginx Dashboard (Port 80)
    reverse_proxy {{ caddy_netbird_upstream }}:{{ caddy_netbird_dashboard_port }} {
        header_up X-Forwarded-Proto {scheme}
    }
}

# ---------------------------------------------------------
# Keycloak (file-select)
# ---------------------------------------------------------
{{ caddy_keycloak_domain }} {
    reverse_proxy {{ caddy_keycloak_upstream }}:8080 {
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-For {remote}
    }
}

# ---------------------------------------------------------
# AdGuard Home (link-cable)
# ---------------------------------------------------------
{{ caddy_adguard_domain }} {
    reverse_proxy {{ caddy_adguard_upstream }}:{{ caddy_adguard_port }} {
        header_up X-Forwarded-Proto {scheme}
    }
}

# ---------------------------------------------------------
# Proxmox VE (gamecube)
# ---------------------------------------------------------
{{ caddy_proxmox_domain }} {
    reverse_proxy https://{{ caddy_proxmox_upstream }}:{{ caddy_proxmox_port }} {
        transport http {
            tls_insecure_skip_verify
        }
    }
}

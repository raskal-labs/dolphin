# roles/pve-init/tasks/main.yml
---
# PVE Initialization: Base packages, repos, time sync, and core SSH key generation.

- name: Install core system packages
  ansible.builtin.apt:
    name:
      - vim
      - curl
      - wget
      - git
      - htop
      - net-tools
      - iproute2
      - gnupg
      - chrony              # Ensure time sync is installed
      - zfsutils-linux
    state: present
    update_cache: true
  tags: [init, packages]

- name: Configure SSH Automation Key on PVE Host (gamecube)
  ansible.builtin.user:
    name: root
    generate_ssh_key: yes
    ssh_key_type: ed25519
    ssh_key_file: /root/.ssh/id_ed25519_ansible
    ssh_key_comment: "dolphin-ansible-automation"
  tags: [init, ssh-key]

- name: üîê Add personal login key for WinSCP/PuTTY access
  ansible.posix.authorized_key:
    user: root
    state: present
    # Use playbook_dir to force looking in the project root 'keys/' folder
    key: "{{ lookup('file', playbook_dir + '/../keys/winscp.pub') }}"
    path: /root/.ssh/authorized_keys
  tags: [init, ssh-key]

- name: Disable Proxmox Enterprise Repo
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/pve-enterprise.list
    regexp: '^deb'
    state: absent
  ignore_errors: true
  tags: [init, repos]

- name: Enable PVE No-Subscription Repo
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/pve-no-subscription.list
    mode: "0644"
    content: |
      deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
  tags: [init, repos]

- name: Update APT cache after repo changes
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags: [init, repos]

- name: Enable ZFS scrub timer (Weekly)
  ansible.builtin.systemd:
    name: "zfs-scrub-weekly@{{ pve_zfs_snapshot_pool }}.timer"
    enabled: yes
    state: started
  tags: [init, zfs]

- name: Enable ZFS trim timer (Monthly)
  ansible.builtin.systemd:
    name: "zfs-trim-monthly@{{ pve_zfs_snapshot_pool }}.timer"
    enabled: yes
    state: started
  tags: [init, zfs]

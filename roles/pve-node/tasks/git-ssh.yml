---
# roles/pve-node/tasks/git-ssh.yml

- name: Ensure /root/.ssh directory exists
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Check if root SSH keypair already exists
  ansible.builtin.stat:
    path: /root/.ssh/id_ed25519
  register: pve_node_ssh_key

- name: Generate root SSH keypair for GitHub if missing
  ansible.builtin.openssh_keypair:
    path: /root/.ssh/id_ed25519
    type: ed25519
    owner: root
    group: root
    mode: "0600"
    comment: "gamecube-dolphin"
  register: pve_node_ssh_keypair
  when: not pve_node_ssh_key.stat.exists

- name: Show public key for adding to GitHub (only on first creation)
  ansible.builtin.debug:
    msg:
      - "Add this SSH public key to your GitHub account (Settings â†’ SSH and GPG keys):"
      - "{{ pve_node_ssh_keypair.public_key }}"
  when:
    - pve_node_ssh_key.stat.exists == false
    - pve_node_ssh_keypair is defined
    - pve_node_ssh_keypair.changed | default(false)

- name: Ensure known_hosts contains GitHub key
  ansible.builtin.known_hosts:
    path: /root/.ssh/known_hosts
    name: github.com
    key: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqq2zu1PZccNsxJ8mBhn4vG4y88WdF5vN1K3yRIFJ"
    state: present

- name: Install git-ssh helper into /usr/local/bin
  ansible.builtin.copy:
    src: git-ssh
    dest: /usr/local/bin/git-ssh
    owner: root
    group: root
    mode: "0755"

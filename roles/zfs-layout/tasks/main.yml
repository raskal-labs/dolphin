---
# Manage ZFS datasets and mountpoints for the homelab layout.

- name: Ensure ZFS datasets exist and apply properties
  # Skips entire role if zfs_layout_enabled is false
  when: zfs_layout_enabled | default(true) 
  block:
    - name: Process datasets
      community.general.zfs:
        name: "{{ item.name }}"
        state: present
        mountpoint: "{{ item.mountpoint | default(omit) }}"
        compression: "{{ item.compression | default('lz4') }}"
        atime: "{{ item.atime | default('off') }}"
      loop: "{{ zfs_datasets }}"
      # Checks three conditions:
      # 1. Is the whole pool block enabled? (e.g., zfs_box1_enabled)
      # 2. Is this specific dataset enabled?
      # 3. Use default(true) if 'enable' is missing from the dictionary item.
      when: 
        - item.pool_enabled | default(true)
        - item.enable | default(true)
      tags: [zfs, storage]

# roles/zfs-layout/tasks/main.yml
---
# Manage ZFS datasets and mountpoints for the homelab layout.

- name: Ensure ZFS datasets exist and apply properties
  when: zfs_layout_enabled | default(true)
  block:
    - name: Process datasets
      community.general.zfs:
        name: "{{ item.name }}"
        state: present
        # FIX: Properties passed via extra_zfs_properties
        extra_zfs_properties: >-
          {{
            {
              'compression': item.compression | default('lz4'),
              'atime': item.atime | default('off')
            } | combine(
              {'mountpoint': item.mountpoint} if item.mountpoint is defined else {}
            )
          }}
      loop: "{{ zfs_datasets }}"
      # Checks three conditions:
      # 1. Is the whole pool block enabled? (e.g., zfs_box1_enabled)
      # 2. Is this specific dataset enabled?
      # 3. Use default(true) if 'enable' is missing from the dictionary item.
      when:
        - item.pool_enabled | default(true)
        - item.enable | default(true)
      tags: [zfs, storage]

- name: Ensure nested backup and volume directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    # SLOT B DUMP TARGET
    - /memory-card/slot-b/vzdump

    # LXC STORAGE (/cart)
    - /cart/demo    # LXC Templates
    - /cart/blocks  # LXC Volumes

    # VM STORAGE (/disc)
    - /disc/demo    # VM ISOs
    - /disc/blocks  # VM Images
  tags: [zfs, storage, backup]

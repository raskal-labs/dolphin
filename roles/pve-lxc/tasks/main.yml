# roles/pve-lxc/tasks/main.yml
---
# Main entry point for LXC management. Requires pve_lxc variable (single container definition).
- name: Update LXC template list
  delegate_to: gamecube
  ansible.builtin.command: pveam update
  changed_when: false
  tags: [lxc, template]

- name: Download LXC template if missing
  delegate_to: gamecube
  vars:
    template_name: "{{ pve_lxc.template | regex_replace('^.*:vztmpl/', '') }}"
    storage_name: "{{ pve_lxc.template | regex_replace(':.*$', '') }}"
    # UPDATE: Point to the 'demo' path
    storage_path: "/cart/demo"
  ansible.builtin.command: "pveam download {{ storage_name }} {{ template_name }}"
  args:
    creates: "{{ storage_path }}/{{ template_name }}"
  tags: [lxc, template]

- name: Assert container definition is provided
  ansible.builtin.assert:
    that:
      - pve_lxc is defined
      - pve_lxc.vmid is defined
      - pve_lxc.hostname is defined
    fail_msg: "LXC container configuration (pve_lxc) is required."
  run_once: true
  tags: [lxc]

# --- Create Bind Mount Directories on PVE Host (Stateful Data) ---
- name: Ensure host bind-mount source directories exist for persistent data
  delegate_to: gamecube
  ansible.builtin.file:
    path: "{{ item.source }}"
    state: directory
    # Set owner/group to 100000/100000 (root inside the unprivileged CT)
    owner: 100000
    group: 100000
    mode: '0755'
  loop: "{{ pve_lxc.mounts | default([]) }}"
  tags: [lxc, storage, mounts]

# --- Create or Update Container ---
- name: Create or Update LXC Container
  ansible.builtin.import_tasks: container.yml
  tags: [lxc, create, config]

- name: Ensure container is started
  delegate_to: gamecube
  ansible.builtin.command: "pct start {{ pve_lxc.vmid }}"
  register: pct_start_check
  # Fail only if error is NOT "already running"
  failed_when: pct_start_check.rc != 0 and 'already running' not in pct_start_check.stderr
  changed_when: pct_start_check.rc == 0
  tags: [lxc, start]

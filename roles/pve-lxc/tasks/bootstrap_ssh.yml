---
# roles/pve-lxc/tasks/bootstrap_ssh.yml
# Bootstrap SSH access into newly created LXCs using the Ansible automation key.

- name: Read host Ansible public key for SSH bootstrap
  ansible.builtin.set_fact:
    pve_lxc_host_pubkey: "{{ lookup('file', '/root/.ssh/id_ed25519_ansible.pub') }}"
  run_once: true

- name: Ensure .ssh directory exists in container
  ansible.builtin.command: "pct exec {{ item.vmid }} -- mkdir -p /root/.ssh"
  changed_when: false

- name: Set permissions on .ssh directory
  ansible.builtin.command: "pct exec {{ item.vmid }} -- chmod 700 /root/.ssh"
  changed_when: false

- name: Ensure authorized_keys exists
  ansible.builtin.command: "pct exec {{ item.vmid }} -- touch /root/.ssh/authorized_keys"
  changed_when: false

- name: Add Ansible public key to authorized_keys if missing
  ansible.builtin.command: >
    pct exec {{ item.vmid }} -- bash -c
    "grep -qx '{{ pve_lxc_host_pubkey }}' /root/.ssh/authorized_keys 2>/dev/null
     || echo '{{ pve_lxc_host_pubkey }}' >> /root/.ssh/authorized_keys"
  changed_when: false

- name: Set permissions on authorized_keys
  ansible.builtin.command: "pct exec {{ item.vmid }} -- chmod 600 /root/.ssh/authorized_keys"
  changed_when: false


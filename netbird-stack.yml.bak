---
# playbooks/netbird-stack.yml
# Provision randnet LXC and install NetBird stack (Docker-based).

- name: Provision NetBird stack LXC on Proxmox
  hosts: gamecube
  gather_facts: false
  vars:
    pve_lxc_containers:
      - vmid: 102
        hostname: randnet
        ip: "{{ hostvars['randnet'].base_debian_network_address }}"
        gateway: "192.168.0.1"
        storage: "cart"
        rootfs_size: "8"
        memory: 1024
        cores: 2
        state: "started" # FIXED TYPO: Was 'stat4e'
        template: "cart:vztmpl/debian-12-standard_12.12-1_amd64.tar.zst"
        features: "nesting=1"
        net_bridge: "vmbr0"
        swap: 0
        onboot: true
        ostype: "debian"
        nameserver: "{{ hostvars['link-cable'].ansible_host }}"
        searchdomain: "lan"
  roles:
    - role: pve-lxc

- name: Bootstrap Debian base on NetBird LXC
  hosts: randnet
  become: true
  gather_facts: false

  pre_tasks:
    - name: Wait for SSH to be ready on randnet
      wait_for_connection:
        timeout: 120
        delay: 10
        sleep: 5

    - name: Gather facts after SSH is up
      setup:

  # NOTE: All configuration variables (OIDC, Relay, etc.) MUST be defined
  # in inventories/prod/group_vars/netbird_stack.yml now.

  roles:
    - role: base-debian
    - role: ssh-base
    - role: netbird-server

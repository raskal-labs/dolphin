---
- name: Remove Proxmox enterprise repo files if present
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/pve-enterprise.list
    - /etc/apt/sources.list.d/pve-enterprise.sources
    - /etc/apt/sources.list.d/ceph.list
    - /etc/apt/sources.list.d/ceph-squid.list
    - /etc/apt/sources.list.d/ceph.sources
  ignore_errors: true

- name: Ensure keyrings dir exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Configure PVE no-subscription repo
  copy:
    dest: /etc/apt/sources.list.d/pve-no-subscription.list
    mode: "0644"
    content: |
      deb [signed-by=/usr/share/keyrings/proxmox-archive-keyring.gpg] http://download.proxmox.com/debian/pve {{ ansible_lsb.codename }} pve-no-subscription

- name: Update APT
  apt:
    update_cache: yes

- name: Configure Proxmox datacenter defaults (best effort)
  copy:
    dest: /etc/pve/datacenter.cfg
    owner: root
    group: www-data
    mode: "0640"
    content: |
      keyboard: {{ dolphin_datacenter_cfg.keyboard }}
      console: {{ dolphin_datacenter_cfg.console }}
  ignore_errors: true

- name: Ensure labs group exists
  command: pveum groupadd {{ dolphin_api_group }}
  register: dolphin_group
  failed_when: dolphin_group.rc != 0 and 'already exists' not in dolphin_group.stderr
  changed_when: "'already exists' not in dolphin_group.stderr"

- name: Ensure labs@pve user exists
  command: pveum useradd {{ dolphin_api_user }} -group {{ dolphin_api_group }}
  register: dolphin_user
  failed_when: dolphin_user.rc != 0 and 'already exists' not in dolphin_user.stderr
  changed_when: "'already exists' not in dolphin_user.stderr"

- name: Grant PVEAdmin role to labs group
  command: pveum aclmod / -group {{ dolphin_api_group }} -role PVEAdmin
  register: dolphin_acl
  failed_when: dolphin_acl.rc != 0 and 'already defined' not in dolphin_acl.stderr
  changed_when: "'already defined' not in dolphin_acl.stderr"

- name: Add storages with pvesm
  shell: |
    if ! pvesm status | awk 'NR>1{print $1}' | grep -qx '{{ item.id }}'; then
      pvesm add {{ item.type }} {{ item.id }} -pool {{ item.pool }} -content {{ item.content }}
    fi
  args:
    executable: /bin/bash
  loop: "{{ dolphin_storages }}"
  loop_control:
    label: "{{ item.id }}"

# playbooks/lxc-adguard.yml
---
# 1. Provisioning Phase
- name: Provision AdGuard LXC (link-cable)
  hosts: gamecube
  become: true
  gather_facts: false

  tasks:
    - name: Delegate container creation to pve-lxc role
      ansible.builtin.include_role:
        name: pve-lxc
      vars:
        pve_lxc: "{{ hostvars['link-cable']['pve_lxc'] }}"

# 2. Configuration Phase
- name: Configure AdGuard Home Application
  hosts: link-cable
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60
        delay: 5

  roles:
    - lxc-adguard

  # --- INFRASTRUCTURE SUMMARY CARD ---
  post_tasks:
    - name: Display Service Information
      vars:
        # Dynamically find the host source paths from the pve_lxc variable
        # We look for the mount that targets the 'conf' and 'work' directories


        mount_conf: "{{ hostvars['link-cable']['pve_lxc']['mounts'] | selectattr('target', 'search', 'conf') | map(attribute='source') | first }}"
        mount_work: "{{ hostvars['link-cable']['pve_lxc']['mounts'] | selectattr('target', 'search', 'work') | map(attribute='source') | first }}"
      ansible.builtin.debug:
        msg:
          - "{{ adguard_ascii_logo }}"
          - "{{ adguard_ascii_install_success }}"
        msg: |
          - "{{ adguard_ascii_logo }}" 
          - " {{ adguard_ascii_install_success }}"
          - ""
          - "AdGuard home"
          - ""
          - "‚úÖ INSTALLATION COMPLETE: AdGuard Home"
          - ""
          - "üì° CONNECTION INFO:"
          - "  - Host: {{ inventory_hostname }}"
          - "  - IP Address: {{ ansible_host | default('N/A') }}"
          - "  - Web UI:      http://{{ ansible_host }}:{{ adguard_web_port | default(3000) }}"
          - "  - DNS Server:  {{ ansible_host }}:{{ adguard_dns_port | default(53) }}"
          - ""
          - "üîë CREDENTIALS:"
          - "  - User:        {{ adguard_api_user | default('raskal') }}"
          - "  - Password:    adguard  (Default, unless changed in vault)"
          - ""
          - "üíæ STATEFUL DATA (ZFS PERSISTENCE):"
          - "  - Config File (Host):      {{ mount_conf }}/AdGuardHome.yaml"
          - "  - Config File (Container): /var/lib/adguardhome/conf/AdGuardHome.yaml"
          - "  - Working Dir (Host):      {{ mount_work }}/"
          - "  - Working Dir (Container): /var/lib/adguardhome/work/"
          - ""
          - "üõ°Ô∏è  INFRASTRUCTURE STATUS:"
          - "  - Container ID: {{ hostvars['link-cable']['pve_lxc']['vmid'] }} (Stateless)"
          - "  - Action:       This container can be destroyed and recreated safely."
          - "                  All logs and settings are preserved on the Host ZFS."
          - "======================================================================"

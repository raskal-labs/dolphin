---
# playbooks/roles/lxc-adguard/tasks/main.yml

- name: Ensure AdGuard data directory exists
  ansible.builtin.file:
    path: /var/lib/adguardhome
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if AdGuardHome binary is already installed
  ansible.builtin.stat:
    path: /opt/AdGuardHome/AdGuardHome
  register: adguard_binary

- name: Download AdGuard Home archive
  ansible.builtin.get_url:
    url: "https://static.adguard.com/adguardhome/release/AdGuardHome_linux_amd64.tar.gz"
    dest: /tmp/AdGuardHome_linux_amd64.tar.gz
    mode: '0644'
  when: not adguard_binary.stat.exists

- name: Extract AdGuard Home archive
  ansible.builtin.unarchive:
    src: /tmp/AdGuardHome_linux_amd64.tar.gz
    dest: /opt
    remote_src: true
  when: not adguard_binary.stat.exists

- name: Check if AdGuardHome systemd unit exists
  ansible.builtin.stat:
    path: /etc/systemd/system/AdGuardHome.service
  register: adguard_unit

- name: Install AdGuard Home as a service (one time)
  ansible.builtin.command:
    argv:
      - /opt/AdGuardHome/AdGuardHome
      - -s
      - install
      - -c
      - /var/lib/adguardhome/AdGuardHome.yaml
      - -w
      - /var/lib/adguardhome
  when: not adguard_unit.stat.exists
  args:
    chdir: /opt/AdGuardHome

- name: Deploy AdGuardHome configuration
  ansible.builtin.copy:
    src: AdGuardHome.yaml
    dest: /var/lib/adguardhome/AdGuardHome.yaml
    owner: root
    group: root
    mode: '0644'
  notify: Restart AdGuardHome

- name: Ensure AdGuard Home service is enabled and running
  ansible.builtin.systemd:
    name: AdGuardHome.service
    enabled: true
    state: started

---
# roles/dolphin/tasks/storage.yml
# Manage Proxmox storage configuration

- name: Ensure storage mountpoints exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /cart
    - /disc

- name: Check if storage.cfg exists
  ansible.builtin.stat:
    path: /etc/pve/storage.cfg
  register: storage_cfg_stat

- name: Backup existing storage.cfg if present
  ansible.builtin.command: >
    cp /etc/pve/storage.cfg /etc/pve/storage.cfg.bak-{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}
  when: storage_cfg_stat.stat.exists
  changed_when: true
  failed_when: false

- name: Render canonical Proxmox storage.cfg
  ansible.builtin.template:
    src: storage.cfg.j2
    dest: /etc/pve/storage.cfg

#!/usr/bin/env bash
set -euo pipefail

KEY_PATH="${KEY_PATH:-/root/.ssh/id_ed25519}"
STATE_FILE="/tmp/ecco-ssh-agent.env"

start_agent() {
  # If we already have a recorded agent, try to reuse it
  if [[ -f "$STATE_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$STATE_FILE" || true
    if [[ -n "${SSH_AGENT_PID:-}" ]] && kill -0 "$SSH_AGENT_PID" 2>/dev/null; then
      return 0
    fi
  fi

  # Start a fresh agent
  eval "$(ssh-agent -s)" >/dev/null

  cat >"$STATE_FILE" <<EOF
export SSH_AUTH_SOCK="$SSH_AUTH_SOCK"
export SSH_AGENT_PID="$SSH_AGENT_PID"
EOF
}

kill_agent() {
  if [[ -f "$STATE_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$STATE_FILE" || true
  fi

  if [[ -n "${SSH_AGENT_PID:-}" ]] && kill -0 "$SSH_AGENT_PID" 2>/dev/null; then
    ssh-agent -k >/dev/null || true
  fi

  rm -f "$STATE_FILE"
  unset SSH_AUTH_SOCK SSH_AGENT_PID
}

load_key() {
  if [[ ! -f "$KEY_PATH" ]]; then
    echo "ecco: key not found at $KEY_PATH" >&2
    exit 1
  fi

  # Check if key already loaded
  if ssh-add -l 2>/dev/null | grep -q "$KEY_PATH"; then
    return 0
  fi

  ssh-add "$KEY_PATH"
}

case "${1:-}" in
  --kill)
    kill_agent
    echo "ecco: ssh-agent killed and state cleared"
    ;;
  "" )
    start_agent
    # shellcheck disable=SC1090
    source "$STATE_FILE"
    load_key
    echo "ecco: ssh-agent ready for Git (SSH_AUTH_SOCK=$SSH_AUTH_SOCK)"
    ;;
  * )
    echo "Usage: ecco [--kill]" >&2
    exit 1
    ;;
esac

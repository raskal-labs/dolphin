---
- name: Ensure resolv.conf has usable DNS servers
  copy:
    dest: /etc/resolv.conf
    content: |
      {% if base_debian_dns_search_domains is defined and base_debian_dns_search_domains | length %}
      search {{ base_debian_dns_search_domains | join(' ') }}
      {% endif %}
      {% for ns in base_debian_dns_servers %}
      nameserver {{ ns }}
      {% endfor %}
    owner: root
    group: root
    mode: '0644'
  when: base_debian_dns_servers is defined and base_debian_dns_servers | length > 0

- name: Ensure apt cache is up to date
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages to latest release
  apt:
    upgrade: "{{ 'dist' if (base_debian_do_dist_upgrade | default(true)) else 'yes' }}"
    autoremove: yes
    autoclean: yes
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Ensure base packages are installed
  apt:
    name: "{{ base_debian_packages }}"
    state: present
  when: base_debian_packages | length > 0

- name: Configure systemd-networkd networking (only when vars are set)
  when:
    - base_debian_manage_networking | default(false)
    - base_debian_network_interface is not none
    - base_debian_network_address is not none
    - base_debian_network_gateway is not none
  block:
    - name: Ensure systemd-networkd is installed
      apt:
        name: systemd-networkd
        state: present

    - name: Write systemd-networkd config for {{ base_debian_network_interface }}
      template:
        src: "20-eth0.network.j2"
        dest: "/etc/systemd/network/20-{{ base_debian_network_interface }}.network"
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start systemd-networkd
      systemd:
        name: systemd-networkd
        enabled: true
        state: started
